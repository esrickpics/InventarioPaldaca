@model InventarioPaldaca.Models.ViewModels.UsuarioPerfilViewModel

@{
    ViewBag.Title = "Perfil del Usuario";
}
@section Styles {
    <link rel="stylesheet" href="~/css/PerfilUsuario.css">
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
}

<!-- Enlaces de navegación -->
<a asp-area="" asp-controller="Activo" asp-action="Index" class="btn btn-success mt-3 btn-space">Ver Activos</a>

<a asp-action="Create" asp-controller="Usuario" class="btn btn-primary mt-3">Nuevo Usuario</a>

<!-- Mensajes de éxito o error -->
@if (TempData["Success"] != null)
{
    <div class="alert alert-success mt-3">@TempData["Success"]</div> 
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger mt-3">@TempData["Error"]</div>
}

<!-- Contenedor principal -->
<div class="container mt-5 mb-5">
    <!-- Formulario de búsqueda -->
    <div class="card">
        <hr class="linea" />
        <div class="card-body cardsearch">
            <!-- Formulario de búsqueda -->
            <form id="searchForm">
                <div class="form-group">
                    <div class="input-group">
                        <!-- Caja de búsqueda con icono -->
                        <div class="search">
                            <span class="material-symbols-outlined search-icon">Search</span>
                            <input type="search" name="searchTerm" id="searchTerm" class="form-control border-start-0 search-input"
                                   placeholder="Buscar Usuario" value="@Model.SearchTerm">
                        </div>
                        <!-- Botón de búsqueda -->
                        <div class="input-group-append">
                            <button type="button" class="btn btn-primary btn-search mt-2" id="searchBtn">Buscar</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Mostrar usuarios encontrados -->
    <div id="usuariosEncontradosContainer">
         <partial name="_UsuariosEncontradosPartial" model="Model" />
    </div>

    <!-- Botón de editar -->
    <div class="text-right mt-4">
        <button id="editarBtn" class="btn btn-primary">Editar Usuario</button>
    </div>
    <div class="user-profile mt-5">
        <form asp-action="EditarUsuario" method="post" id="perfilForm">
            @Html.AntiForgeryToken()
            <input type="hidden" name="UsuarioId" value="@Model.UsuarioId" />

            <!-- Fila principal: Información del usuario y activos asociados -->
            <div class="row">
                <!-- Columna izquierda: Imagen e información del usuario -->
                <div class="col-md-6">
                    <div class="row">
                        <!-- Imagen del usuario -->
                        <div class="col-md-4 text-center">
                            <img src="@Url.Content(Model.UsuarioImagenUrl)" alt="Imagen del usuario" class="img-fluid rounded-circle user-profile">
                        </div>
  
                        <!-- Información del usuario -->

                        <div class="col-md-8">
                            <div class="profile-header-info">
                                <h1>
                                    <span id="displayNombre">@Model.UsuarioNombre</span>
                                    <input asp-for="UsuarioNombre" class="form-control d-none" placeholder="Nombre del usuario" />
                                    <span id="displayApellido">@Model.UsuarioApellido</span>
                                    <input asp-for="UsuarioApellido" class="form-control d-none" placeholder="Apellido del usuario" />
                                </h1>
                                <p>
                                    <span id="displayCargo">@Model.UsuarioCargo</span>
                                    <input asp-for="UsuarioCargo" class="form-control d-none" placeholder="Cargo del usuario" />
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Columna derecha: Activos asociados -->
                <div class="col-md-6">
                    <div class="profile-assets-table">
                        <h2>Activos Asociados</h2>
                        @if (Model.ActivosAsociados != null && Model.ActivosAsociados.Any())
                        {
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Marca</th>
                                        <th>Modelo</th>
                                        <th>Código de Inventario</th>
                                        <th>Categoría</th>
                                        <th>Ubicación</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var activo in Model.ActivosAsociados)
                                    {
                                        <tr>
                                            <td>@activo.Marca</td>
                                            <td>@activo.Modelo</td>
                                            <td>@activo.CodigoInventario</td>
                                            <td>@activo.CategoriaName</td>
                                            <td>@activo.UbicacionName</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                        else
                        {
                            <p>No hay activos asociados a este usuario.</p>
                        }
                    </div>
                </div>
            </div>

            <!-- Fila para información de contacto -->
            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="profile-content">
                        <h2>Información de Contacto</h2>
                        <div class="contact-info">
                            <!-- Correo Electrónico -->
                            <div class="contact-item">
                                <i class="fas fa-envelope"></i>
                                <span id="displayCorreo">@Model.UsuarioCorreo</span>
                                <input asp-for="UsuarioCorreo" class="form-control d-none" placeholder="Correo electrónico" />
                            </div>
                            <!-- Teléfono -->
                            <div class="contact-item mt-2">
                                <i class="fas fa-phone"></i>
                                <span id="displayTelefono">@Model.UsuarioTelefono</span>
                                <input asp-for="UsuarioTelefono" class="form-control d-none" placeholder="Número de teléfono" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Validación y botones -->
            <div asp-validation-summary="ModelOnly" class="text-danger mt-3"></div>
            <div class="text-right mt-4">
                <button type="submit" id="guardarBtn" class="btn btn-success d-none">Guardar</button>
                <button type="button" id="cancelarBtn" class="btn btn-danger d-none">Cancelar</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.getElementById("editarBtn").addEventListener("click", function () {
            // Ocultar los spans y mostrar los inputs
            document.querySelectorAll("#perfilForm span").forEach(function (span) {
                span.classList.add("d-none");
            });
            document.querySelectorAll("#perfilForm input").forEach(function (input) {
                input.classList.remove("d-none");
                input.style.display = 'block';
            });

            // Mostrar los botones "Guardar" y "Cancelar"
            document.getElementById("guardarBtn").classList.remove("d-none");
            document.getElementById("cancelarBtn").classList.remove("d-none");
            // Ocultar el botón "Editar"
            document.getElementById("editarBtn").classList.add("d-none");
        });

        document.getElementById("cancelarBtn").addEventListener("click", function () {
            // Ocultar los inputs y mostrar los spans
            document.querySelectorAll("#perfilForm input").forEach(function (input) {
                input.classList.add("d-none");
                input.style.display = 'none';
            });
            document.querySelectorAll("#perfilForm span").forEach(function (span) {
                span.classList.remove("d-none");
            });

            // Ocultar los botones "Guardar" y "Cancelar"
            document.getElementById("guardarBtn").classList.add("d-none");
            document.getElementById("cancelarBtn").classList.add("d-none");
            // Mostrar el botón "Editar"
            document.getElementById("editarBtn").classList.remove("d-none");
        });

            document.getElementById("searchTerm").addEventListener("keydown", function (event) {
                // Detectar si la tecla presionada es "Enter"
                if (event.key === "Enter") {
                    event.preventDefault(); 
                    document.getElementById("searchBtn").click(); // Simular clic en el botón de búsqueda
                }
            });

        document.getElementById("searchBtn").addEventListener("click", function () {
            var searchTerm = document.getElementById("searchTerm").value.trim();

            if (!searchTerm) {
                // Si el campo de búsqueda está vacío, no realizar la solicitud
                document.getElementById("usuariosEncontradosContainer").innerHTML = '';
                document.getElementById("noUsersFoundMessage").classList.remove("d-none");
                return;
            }

            var url = `/Usuario/PerfilUsuario?id=@Model.UsuarioId&searchTerm=${encodeURIComponent(searchTerm)}`;

            fetch(url, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.text())
                .then(html => {
                    var usuariosEncontradosContainer = document.getElementById("usuariosEncontradosContainer");
                    usuariosEncontradosContainer.innerHTML = html;

                    var noUsersFoundMessage = document.getElementById("noUsersFoundMessage");
                    if (!document.querySelector("#usuariosEncontradosContainer .list-group-item")) {
                        noUsersFoundMessage.classList.remove("d-none");
                    } else {
                        noUsersFoundMessage.classList.add("d-none");
                    }
                });
        });
    </script>
}
